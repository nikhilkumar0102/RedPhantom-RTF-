import subprocess
from utils.result_saver import save_text_result
from core.logger import log_event

# ================= COLORS =================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================
BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔════════════════════════════════════════════╗
║              EXPLOIT RUNNER                ║
║      Controlled • Logged • Authorized      ║
╚════════════════════════════════════════════╝
{Colors.END}
"""

# ================= HELPERS =================

def run_cmd(cmd):
    try:
        out = subprocess.check_output(
            cmd, shell=True, stderr=subprocess.STDOUT
        ).decode()
        return out
    except subprocess.CalledProcessError as e:
        return e.output.decode()


def confirm_auth():
    ans = input(
        f"{Colors.RED}[!] Confirm exploitation authorization (yes/no): {Colors.END}"
    )
    return ans.strip().lower() == "yes"


# ================= METASPLOIT RUNNER =================

def run_msf_module(engagement):
    print(f"\n{Colors.YELLOW}[*] Metasploit guided execution{Colors.END}")

    module = input("msf module path: ").strip()
    rhost = input("RHOSTS: ").strip()
    lhost = input("LHOST: ").strip()

    msf_script = f"""
use {module}
set RHOSTS {rhost}
set LHOST {lhost}
run
exit
"""

    print(f"{Colors.BLUE}[*] Launching Metasploit...{Colors.END}")
    output = run_cmd(f'msfconsole -q -x "{msf_script}"')

    save_text_result(
        engagement,
        phase="exploitation",
        category="msf",
        tool="metasploit_run",
        content=output
    )

    log_event(engagement, f"Metasploit module executed: {module}")

    print(f"{Colors.GREEN}[✓] Metasploit run complete{Colors.END}")


# ================= SEARCHSPLOIT RUNNER =================

def run_searchsploit(engagement):
    query = input("searchsploit query: ").strip()

    print(f"{Colors.YELLOW}[*] Searching exploit DB...{Colors.END}")
    output = run_cmd(f"searchsploit {query}")

    print(output)

    save_text_result(
        engagement,
        phase="exploitation",
        category="searchsploit",
        tool="searchsploit_query",
        content=output
    )

    log_event(engagement, f"Searchsploit query: {query}")


# ================= CUSTOM EXPLOIT =================

def run_custom(engagement):
    cmd = input("Custom exploit command: ").strip()

    print(f"{Colors.YELLOW}[*] Executing custom exploit command...{Colors.END}")
    output = run_cmd(cmd)

    print(output)

    save_text_result(
        engagement,
        phase="exploitation",
        category="custom",
        tool="custom_exploit",
        content=output
    )

    log_event(engagement, f"Custom exploit executed: {cmd}")


# ================= VERSION → MSF SEARCH BRIDGE =================

def version_to_msf_search(engagement):
    version = input("Service/version string: ").strip()

    print(f"{Colors.YELLOW}[*] Searching Metasploit modules...{Colors.END}")
    output = run_cmd(f'msfconsole -q -x "search {version}; exit"')

    print(output)

    save_text_result(
        engagement,
        phase="exploitation",
        category="msf_search",
        tool="msf_search",
        content=output
    )


# ================= MAIN MENU =================

def run(engagement):
    print(BANNER)

    if not confirm_auth():
        print(f"{Colors.RED}[!] Exploitation not authorized{Colors.END}")
        return

    while True:
        print(f"""
{Colors.BOLD}[1]{Colors.END} Run Metasploit Module
{Colors.BOLD}[2]{Colors.END} Searchsploit Lookup
{Colors.BOLD}[3]{Colors.END} Version → MSF Search
{Colors.BOLD}[4]{Colors.END} Run Custom Exploit Command
{Colors.RED}[5] Back{Colors.END}
""")

        choice = input("Select option: ").strip()

        if choice == "1":
            run_msf_module(engagement)

        elif choice == "2":
            run_searchsploit(engagement)

        elif choice == "3":
            version_to_msf_search(engagement)

        elif choice == "4":
            run_custom(engagement)

        elif choice == "5":
            break

        else:
            print(f"{Colors.RED}[!] Invalid option{Colors.END}")
