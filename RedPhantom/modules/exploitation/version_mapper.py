import re
import subprocess
from utils.result_saver import save_text_result, save_json_result

# ================= COLORS =================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================
BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔══════════════════════════════════════╗
║      VERSION → EXPLOIT MAPPER        ║
║      Service • Version • CVE         ║
╚══════════════════════════════════════╝
{Colors.END}
"""

# ================= HELPERS =================

def run_cmd(cmd):
    try:
        return subprocess.check_output(
            cmd, shell=True, stderr=subprocess.DEVNULL
        ).decode()
    except Exception:
        return ""


def searchsploit_exists():
    return subprocess.call(
        "which searchsploit",
        shell=True,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL
    ) == 0


def parse_nmap_versions(text):
    """
    Extract service/version lines from nmap output.
    """
    matches = []
    for line in text.splitlines():
        if "/tcp" in line and "open" in line:
            matches.append(line.strip())
    return matches


# ================= CORE LOGIC =================

def search_exploits(query):
    if not searchsploit_exists():
        return "[searchsploit not installed]"

    result = run_cmd(f"searchsploit {query}")
    return result if result else "[no exploits found]"


# ================= MAIN =================

def run(engagement):

    print(BANNER)

    print(f"{Colors.YELLOW}Input Options:{Colors.END}")
    print("1. Paste service/version string")
    print("2. Provide Nmap output file")

    mode = input("Select option: ").strip()

    services = []

    # ---------- INPUT MODE ----------
    if mode == "1":
        svc = input("Enter service/version (example: Apache 2.4.49): ")
        services.append(svc)

    elif mode == "2":
        path = input("Path to nmap output file: ").strip()
        try:
            with open(path) as f:
                content = f.read()
            services = parse_nmap_versions(content)
        except:
            print(f"{Colors.RED}[!] Could not read file{Colors.END}")
            return

    else:
        print("Invalid option")
        return

    # ---------- MAPPING ----------
    report_lines = []
    json_data = []

    for svc in services:

        print(f"\n{Colors.YELLOW}[*] Mapping exploits for:{Colors.END} {svc}")

        exploits = search_exploits(svc)

        report_lines.append(f"\nSERVICE: {svc}")
        report_lines.append("-" * 50)
        report_lines.append(exploits)

        json_data.append({
            "service": svc,
            "exploits": exploits.splitlines()[:20]  # limit size
        })

        if "[no exploits" not in exploits:
            print(f"{Colors.GREEN}[+] Potential exploits found{Colors.END}")
        else:
            print(f"{Colors.RED}[-] No exploit matches{Colors.END}")

    # ---------- SAVE ----------
    text_path = save_text_result(
        engagement,
        phase="exploitation",
        category="version_mapping",
        tool="version_mapper",
        content="\n".join(report_lines)
    )

    json_path = save_json_result(
        engagement,
        phase="exploitation",
        category="version_mapping",
        tool="version_mapper",
        data=json_data
    )

    print(f"\n{Colors.GREEN}{Colors.BOLD}[✓] Version mapping complete{Colors.END}")
    print(f"{Colors.BLUE}Saved text:{Colors.END} {text_path}")
    print(f"{Colors.BLUE}Saved json:{Colors.END} {json_path}")
