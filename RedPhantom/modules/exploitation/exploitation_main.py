# modules/exploitation/exploitation_main.py
#!/usr/bin/env python3

import os
import sys

# ================= PATH FIX =================
CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.abspath(os.path.join(CURRENT_DIR, "../../"))
if PROJECT_ROOT not in sys.path:
    sys.path.append(PROJECT_ROOT)

# ================= IMPORTS =================

from modules.exploitation import (
    exploits_search,
    version_mapper,
    exploits_runner
)

from modules.exploitation.payloads import (
    payload_main,
    blind_shell,
    payload_transformer,
    reverse_shell_gen
)

# ================= COLORS =================

class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================

BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔════════════════════════════════════════════╗
║            EXPLOITATION PHASE              ║
║      Search • Map • Execute • Payloads     ║
╚════════════════════════════════════════════╝
{Colors.END}
"""

# ================= MENU =================

def main_menu():
    print(BANNER)
    print(f"""
{Colors.WHITE}[1] Exploit Search{Colors.END}
{Colors.WHITE}[2] Version → Exploit Mapper{Colors.END}
{Colors.WHITE}[3] Exploit Runner{Colors.END}
{Colors.YELLOW}[4] Payload Generator{Colors.END}
{Colors.YELLOW}[5] Full Exploitation Flow{Colors.END}
{Colors.RED}[6] Back to Main Menu{Colors.END}
""")
    return input("Select option: ").strip()


# ================= SAFE RUN =================

def safe_run(module, engagement, name):
    if hasattr(module, "run"):
        module.run(engagement)
    else:
        print(f"{Colors.YELLOW}[!] {name} missing run(){Colors.END}")


# ================= PHASE ENTRY =================

def run(engagement):

    while True:
        choice = main_menu()

        # -------- Exploit Search --------
        if choice == "1":
            safe_run(exploits_search, engagement, "exploits_search")

        # -------- Version Mapper --------
        elif choice == "2":
            safe_run(version_mapper, engagement, "version_mapper")

        # -------- Exploit Runner --------
        elif choice == "3":
            safe_run(exploits_runner, engagement, "exploits_runner")

        # -------- Payload Generator --------
        elif choice == "4":
            safe_run(payload_main, engagement, "payload_main")

        # -------- Full Flow --------
        elif choice == "5":
            print(f"{Colors.GREEN}[*] Running full exploitation workflow...{Colors.END}")

            safe_run(exploits_search, engagement, "exploits_search")
            safe_run(version_mapper, engagement, "version_mapper")
            safe_run(exploits_runner, engagement, "exploits_runner")
            safe_run(reverse_shell_gen, engagement, "reverse_shell_gen")
            safe_run(payload_transformer, engagement, "payload_transformer")

        # -------- Exit --------
        elif choice == "6":
            break

        else:
            print(f"{Colors.RED}[!] Invalid option{Colors.END}")
                                             