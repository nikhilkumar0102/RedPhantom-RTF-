import os
import subprocess
import shutil
import requests
from datetime import datetime

# ================= COLORS =================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================
BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔════════════════════════════════════════════╗
║            EXPLOIT SEARCH MODULE           ║
║        CVE • ExploitDB • Version Map       ║
╚════════════════════════════════════════════╝
{Colors.END}
"""

# ================= HELPERS =================
def tool_exists(tool):
    return shutil.which(tool) is not None


def run_cmd(cmd):
    try:
        return subprocess.check_output(
            cmd, shell=True, stderr=subprocess.DEVNULL
        ).decode()
    except Exception:
        return ""


def save_results(engagement, content):
    base = os.path.join(engagement["base"], "exploits")
    os.makedirs(base, exist_ok=True)

    filename = f"exploit_search_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    path = os.path.join(base, filename)

    with open(path, "w") as f:
        f.write(content)

    return path


# ================= SEARCHSPLOIT =================
def search_with_searchsploit(query):
    if not tool_exists("searchsploit"):
        return None

    print(f"{Colors.YELLOW}[*] Using searchsploit (ExploitDB)...{Colors.END}")
    result = run_cmd(f"searchsploit {query}")
    return result if result.strip() else None


# ================= NVD CVE LOOKUP =================
def search_nvd_cve(query):
    print(f"{Colors.YELLOW}[*] Querying NVD CVE database...{Colors.END}")

    try:
        url = f"https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch={query}"
        r = requests.get(url, timeout=10)

        if r.status_code != 200:
            return None

        data = r.json()
        vulns = data.get("vulnerabilities", [])[:5]

        if not vulns:
            return None

        out = ["\nTop CVE Matches:\n"]

        for v in vulns:
            cve = v["cve"]["id"]
            desc = v["cve"]["descriptions"][0]["value"][:200]
            out.append(f"{cve} — {desc}")

        return "\n".join(out)

    except Exception:
        return None


# ================= MAIN =================
def run(engagement):
    print(BANNER)

    print(f"{Colors.WHITE}Enter service details for exploit lookup{Colors.END}")

    service = input(f"{Colors.YELLOW}Service name (e.g., apache): {Colors.END}").strip()
    version = input(f"{Colors.YELLOW}Version (optional): {Colors.END}").strip()

    query = f"{service} {version}".strip()

    report = []
    report.append("EXPLOIT SEARCH RESULTS")
    report.append("=" * 50)
    report.append(f"Query: {query}\n")

    # ---------- SearchSploit ----------
    ss = search_with_searchsploit(query)
    if ss:
        report.append("=== ExploitDB Matches ===")
        report.append(ss)
        print(f"{Colors.GREEN}[+] ExploitDB matches found{Colors.END}")
    else:
        print(f"{Colors.YELLOW}[-] No searchsploit matches or tool missing{Colors.END}")

    # ---------- CVE Lookup ----------
    cves = search_nvd_cve(query)
    if cves:
        report.append("\n=== CVE Matches ===")
        report.append(cves)
        print(f"{Colors.GREEN}[+] CVE matches found{Colors.END}")
    else:
        print(f"{Colors.YELLOW}[-] No CVE matches found{Colors.END}")

    # ---------- Guidance ----------
    report.append("\nNEXT STEPS:")
    report.append("- Validate service version")
    report.append("- Confirm exploit applicability")
    report.append("- Use version_mapper module")
    report.append("- Test in controlled manner")

    # ---------- Save ----------
    path = save_results(engagement, "\n".join(report))

    print(f"\n{Colors.GREEN}{Colors.BOLD}[✓] Exploit search completed{Colors.END}")
    print(f"{Colors.BLUE}[+] Results saved to:{Colors.END} {path}")
