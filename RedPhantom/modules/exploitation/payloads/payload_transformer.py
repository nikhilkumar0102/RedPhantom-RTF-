import base64
import hashlib
import urllib.parse
from datetime import datetime
import os

# ================= COLORS =================
class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    WHITE = '\033[97m'
    BOLD = '\033[1m'
    END = '\033[0m'

# ================= BANNER =================
BANNER = f"""
{Colors.BLUE}{Colors.BOLD}
╔════════════════════════════════════════════╗
║          PAYLOAD TRANSFORMER               ║
║   Encode • Wrap • Hash • Convert           ║
╚════════════════════════════════════════════╝
{Colors.END}
"""

# ================= SAVE =================
def save_output(engagement, content):
    base = os.path.join(engagement["base"], "payloads")
    os.makedirs(base, exist_ok=True)

    name = f"payload_transform_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    path = os.path.join(base, name)

    with open(path, "w") as f:
        f.write(content)

    return path


# ================= MENU =================
def menu():
    print(f"""
{Colors.WHITE}[1] Base64 Encode{Colors.END}
{Colors.WHITE}[2] URL Encode{Colors.END}
{Colors.WHITE}[3] Hex Encode{Colors.END}
{Colors.WHITE}[4] Generate Hashes (MD5/SHA256){Colors.END}
{Colors.WHITE}[5] Add Safe Wrapper Template{Colors.END}
{Colors.RED}[6] Back{Colors.END}
""")
    return input("Select option: ").strip()


# ================= TRANSFORMS =================
def b64_encode(data):
    return base64.b64encode(data.encode()).decode()


def url_encode(data):
    return urllib.parse.quote(data)


def hex_encode(data):
    return data.encode().hex()


def make_hashes(data):
    return {
        "md5": hashlib.md5(data.encode()).hexdigest(),
        "sha256": hashlib.sha256(data.encode()).hexdigest()
    }


def safe_wrapper(data):
    return f"""
# ===== SAFE LAB WRAPPER =====
# Generated for transport/testing
payload = \"\"\"{data}\"\"\"

print("Payload length:", len(payload))
# =============================
"""


# ================= RUN =================
def run(engagement):
    print(BANNER)

    payload = input(f"{Colors.YELLOW}Enter payload text:{Colors.END}\n")

    report_lines = []
    report_lines.append("PAYLOAD TRANSFORM RESULTS")
    report_lines.append("=" * 40)
    report_lines.append(f"Original:\n{payload}\n")

    while True:
        choice = menu()

        if choice == "1":
            out = b64_encode(payload)
            print(f"{Colors.GREEN}\nBase64:\n{out}{Colors.END}")
            report_lines.append(f"\n[Base64]\n{out}")

        elif choice == "2":
            out = url_encode(payload)
            print(f"{Colors.GREEN}\nURL Encoded:\n{out}{Colors.END}")
            report_lines.append(f"\n[URL Encoded]\n{out}")

        elif choice == "3":
            out = hex_encode(payload)
            print(f"{Colors.GREEN}\nHex:\n{out}{Colors.END}")
            report_lines.append(f"\n[Hex]\n{out}")

        elif choice == "4":
            hashes = make_hashes(payload)
            print(f"{Colors.GREEN}\nMD5: {hashes['md5']}")
            print(f"SHA256: {hashes['sha256']}{Colors.END}")
            report_lines.append(f"\n[Hashes]\n{hashes}")

        elif choice == "5":
            out = safe_wrapper(payload)
            print(f"{Colors.GREEN}{out}{Colors.END}")
            report_lines.append(f"\n[Wrapper]\n{out}")

        elif choice == "6":
            break

        else:
            print(f"{Colors.RED}Invalid option{Colors.END}")

    path = save_output(engagement, "\n".join(report_lines))

    print(f"\n{Colors.GREEN}{Colors.BOLD}[✓] Saved to:{Colors.END} {path}")
